---
title: "stp25stat2"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
require(knitr)
 
 
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%",
  comment = "#"
)

options(
  knitr.kable.NA = "",
  width = 60
)


```

 
  
This library provides a simple and intuitive formula and pipe-based framework for performing basic statistical tests such as t-test, Wilcoxon test, ANOVA, Kruskal-Wallis and correlation analysis.

The output of each test is automatically converted into an APA-style table.

Additional functions for transforming, rearranging and manipulating are included in *spp25tools*. 
Visualisation functions are included in *stp25plot*.
  

```{r}
require(stp25stat2)
# which_output()
```

  
## Descriptive statistics


- `Tbll_desc`, `Tbll_desc_long()`,  `Tbll_desc_item()` und `Tbll_desc_multi`: Calculate descriptive statistics for one or more numerical variables. Can deal with grouped data.
- `Tbll_xtabs()`:  Calculates crosstabs of categorical variables.
- `Tbll_corr()`: Correlation test between two or more variables using Pearson, Spearman or Kendall methods.


### Tbll_desc


```{r, Tbll_desc-basic, error=TRUE}

Tbll_desc(~ breaks + wool, warpbreaks)

warpbreaks |> Tbll_desc(~breaks + wool)

warpbreaks |> Tbll_desc(breaks, wool)
```
    
    
```{r, Tbll_desc-groups-test}
warpbreaks |> Tbll_desc(
  "H1",
  breaks,
  tension,
  by = ~ wool,
  include.total = TRUE,
  include.n = FALSE,
  include.test = TRUE) |> kable()
```
    
    
     
```{r, Tbll_desc_long-basic, results='asis'}
mtcars |> Tbll_desc_long(
  mpg[mean, 1],  cyl[median],  disp[0],
  hp[0],  drat,  wt,  qsec[1],  vs[freq],
  am[freq],  gear,  carb,
  include.range = TRUE,  include.n = TRUE
) |> kable(caption ="summary statistics" )
```
 
 
```{r data-set-2, include=FALSE}
require(stp25stat2)
require(stp25tools)
n<- 100
set.seed(1)
DF <- data.frame(
  sex= gl(2, n/3, labels = c("male", "female"))[sample.int(n)],
  group = gl(2, n/3, labels = c("Control", "Treat"))[sample.int(n)],
  age= runif(n, min = 18, max = 73),
  smoker =  rbinom(n, size=1, prob=.25)==1,
  alc = gl(3, n/3, labels = c("non", "Occasionally", "Abuse"))[sample.int(n)],
  diabet=  rbinom(n, size=1, prob=.5)==1,
  metabolic = rbinom(n, size=1, prob=.3)==1,
  cardo=  rbinom(n, size=1, prob=.1)==1,
  infect= factor( rbinom(n, size=1, prob=.77), 0:1, c("yes", "no")),
  bili=  rnorm(n, 0.83, 0.40)
) |> 
  na.omit() |> 
  Label(
  smoker = "Tobacco Smoker",
  group = "Group",
  sex = "Sex",
  alc = "Alcohol Consumption",
  age="Age",
  
 diabet= "Diabetes" ,
 cardo = "Cardiovascular Disease" ,
 metabolic =  "Chronic Metabolic Disease ",
 infect = "Chronic Infections" ,
  bili = "Serum Bilirubin (mg/dl)"
    
)

      
```

```{r set_opt}
set_opt(
  caption=TRUE,
  median = list(digits = 0, style=1),
  prozent = list(style=2, 
                 digits=1,
                 percentage_str="%",
                 
                 null_percent_sign =  ' . ',
                 
                 include_level_multi = TRUE)
) 
```
 
```{r tbll_desc-options, results='asis'}
DF |>
  Tbll_desc(
    sex[ratio],
    group[freq],
    age[median],
    alc, smoker,
    "Clinical/Pretreatment",
    diabet,
    cardo,
    metabolic,
    infect[multi],
    bili[median,3],
    
    by = ~ group,
    include.total = TRUE,
    
    include.custom = stp25stat2:::effect_size
    # include.custom =  function(x ,
    #                            by, ...) {
    #   x <- scale(as.numeric(x))
    #   round(diff(sapply(split(x, by), mean, na.rm = TRUE)), 2)
    # },
    # 
    # include.value = c(group = "OR = .0256", sex = "swx = 26")
  ) |> stp25output2::Output()
```
 
 Hinzuf체gen von zus채tzliche Spalten mit
 **include.value**.
 Vector oder data.frame in exact der Reihenfolge wie die meassure-variablen.
 
```{r tbll-desc-add-df}
Info <- data.frame( var_name=c("age", "sex"), y=1:2)
rownames(Info) <- c("age", "sex" )

DF |>
  Tbll_desc(
    sex[ratio],
    group[freq],
    "Zwichen Ueberschrift",
    age[median],
    by = ~ group,
    include.total = TRUE,
    include.value = Info,
    include.nr = TRUE
  ) |> kable()
```
 
### Tbll_likert 
 
- `Tbll_likert()`: Univariate
    
```{r data-likert, include=FALSE}
#'set.seed(1)
n <- 100
lvs <- c("--", "-", "o", "+", "++")
DF2 <- data.frame(
  Magazines = cut(rnorm(n), 5, lvs),
  Comic.books = cut(rnorm(n), 5, lvs),
  Fiction = cut(rnorm(n), 5, lvs),
  Newspapers = cut(rnorm(n), 5, lvs),
  Geschlecht = cut(rnorm(n), 2, c("m", "f"))
)


```

```{r Tbll_likert}
Lik <- Tbll_likert(DF2,
                   Magazines, Comic.books, Fiction, Newspapers,
                   ReferenceZero=2)

Lik
```
  
```
stp25plot::likertplot(
     Item  ~ . , 
     data = Lik)
```
  

### Tbll_xtabs 
         
     
```{r data_xtab, include=FALSE}
data(infert, package = "datasets")
DF <- infert
DF$case  <- factor(DF$case , 1:0, c("case", "control"))

DF$spontaneous <- factor(DF$spontaneous)
DF$induced2    <- factor(DF$induced == 0)

```
   
```{r}
Tbll_xtabs( ~ induced + education + case,
            DF,
            margin = "case",
            include.count = FALSE)
```
   
  
```{r}
Tbll_xtabs(
  ~ induced + education + case,
  DF,
  margin = "case",
  add.margins =1:3,
  include.count = FALSE,
  include.test =TRUE
)
```
   
   
   
   
   
   
     
### Tbll_corr
   
 
```{r data-corr, include=FALSE}
n <- 2 * 20
e <- rnorm(n)
dat <-  Label(
  data.frame(
    a = rnorm(n) + e / 2,
    b = rnorm(n) + e,
    c = rnorm(n),
    d = rnorm(n) + e * 10,
    g = gl(2, 20, labels = c("Control", "Treat"))
  ),
  a = "Alpha",
  b = "Beta",
  c = "Gamma"
)

```
 
 
```{r Tbll_corr}
Tbll_corr( ~ a + b + c, dat)
Tbll_corr(a ~ c, dat)
Tbll_corr(a + b + c ~ d, dat)
Tbll_corr(a + b + c ~ d, 
          dat, 
          groups = ~ g, 
          include.n=FALSE) |>  kable()
```
 
 
``` 
stp25plot::corr_plot( ~ a + b + c + d, 
                       dat,
                       resize=TRUE
 )
```
 
 
  
    
## Reliability
 
- `Tbll_desc_item()`, `Tbll_reliability()` and  `Tbll_item_analysis()`: 

 
```{r data-set-3, include=FALSE}
df <- data.frame(
  A = c(1,2,3,4,5, 1,1,1,2, 1,1,1,5,5,5),
  B = c(1,2,3,4,5, 2,2,2,1, 1,1,1,5,5,5),
  C = c(1,2,3,4,5, 3,3,3,4, 1,1,1,5,5,5),
  D = c(1,2,3,5,5, 4,5,4,5, 1,1,1,5,5,5),
  E = c(1,2,3,4,5, 3,2,1,1, 1,1,1,5,5,5)
)

df$index <-scale( rowSums(df) )
```

```{r Tbll_desc_item}
Tbll_desc_item( ~ A + B + C + D + E, df)
```

```{r Tbll_reliability}
Tbll_reliability( ~ A + B + C + D + E, df,
                 include.item_statistics = TRUE)
```
 
```{r Tbll_item_analysis}
Tbll_item_analysis(  A + B + C + D + E ~ index, df,
                     include.Sample.SD =  TRUE,
                     include.Item.total = TRUE,   #  (unkorrigierte) Trennsch채rfe
           
                     include.Item.Tot.woi = TRUE, # korrigierte Trennsch채rfe Alpha if Item Deleted
                     include.Difficulty = TRUE,    # Itemschwierigkeit
                     include.Discrimination = TRUE,
                     
                     include.Item.Reliab = TRUE,
                     include.Item.Rel.woi = TRUE
                     )
```



### Sig. Test




```{r}
t1 <- wilcox.test(mpg ~ vs, mtcars)
t1
Tbll(t1)
APA(t1)

 
```



## Regression


```{r}

 lm1 <- lm(breaks ~ wool + tension, data = warpbreaks)
 lm2 <- lm(breaks ~ wool * tension, data = warpbreaks)
 
 Infomation(lm1, lm2)

 Tbll_reg(
  lm1,
  lm2,
  include.p = FALSE,
  include.ci = TRUE,
  include.se=FALSE
)


 Tbll_reg(
   lm2,
   include.p = TRUE,
   include.beta = TRUE,
   include.gof = FALSE,
   include.statistic = TRUE,
   include.stars = TRUE
 )





```

```{r}
 counts <- c(18,17,15,20,10,20,25,13,12)
 outcome <- gl(3,1,9)
 treatment <- gl(3,3)
 data.frame(treatment, outcome, counts) # showing data
 lm.D93 <- lm(counts ~ outcome + treatment )
 glm.D93 <- glm(counts ~ outcome + treatment, family = poisson())
 Tbll_reg(lm.D93, glm.D93, digits=2)
 Tbll_reg(lm.D93, glm.D93, digits=c(0,2,2,1,1))
```

